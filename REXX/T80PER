/*REXX*/
ARG ACID RESTYPE RESNAME ACCESS DAYS
SIGNAL OFF ERROR
SECRC = "T80PER FAILED WITH ERRORS"
ADDRESS ISPEXEC "VPUT SECRC PROFILE"
/**********************/
/* VARIABLE INIT AREA */
/**********************/
RES.0 = 3
RES.1 = "DATASET"
RES.2 = "JESSPOOL"
RES.2 = "VOL"
RESCHK = TRANSLATE(RESNAME,"Z","*") /* REPLACE ASTERISK WITH Z */
/**********************/
/* VARIABLE CHECK AREA*/
/**********************/
DO Q = 1 TO RES.0
  IF RES.Q = RESTYPE THEN VALID = "YES"
END
IF VALID /= "YES" THEN DO
  SAY "T80PER: RESTYPE NOT SUPPORTED. RESTYPE = " RESTYPE
  MSG2 = "THE FOLLOWING RESTYPE WAS NOT RECOGNIZED" RESTYPE
  ADDRESS ISPEXEC "VPUT MSG2 PROFILE"
  EXIT 08
END
ACTION = "ACTION(FAIL)"
IF DAYS /= " " THEN DAYCMD = "FOR("DAYS")"
SLASH = INDEX("/",DAYS)
IF SLASH > 0 THEN DAYCMD = "UNTIL("DAYS")"
DAY1 = WORD(DAYS,1)
SIGNAL NOCHECK
RESCHK = TRANSLATE(RESNAME,"Z","*") /* REPLACE DOTS WITH SPACES */
ACCCHK = ACCESS
Q = OUTTRAP(HOLD.,5)
IF ACCESS = "ALL" THEN ACCCHK = "ALTER"
IF ACCESS = "REMOVE" THEN ACCCHK = "ALTER"
SAY "T80PER: ACTION IS NOW" ACTION ". DAYS VALUE IS " DAYS
SAY "T80PER: RES IS " RESNAME
SAY "********CHECK IS BELOW **************"
SAY " TSSCHECK("RESTYPE","RESCHK","ACCCHK",NOMSG)"
X5 = TSSCHECK(RESTYPE,RESCHK,ACCCHK,"NOMSG")
SAY "********CHECK IS BELOW **************"
SAY "T80PER: TSSCHECK RETURN CODE IS " X5
IF X5 Â¬= "OK"  THEN DO
  SECRC = "YOU CANNOT GRANT THAT LEVEL OF ACCESS TO THAT RESOURCE."
  ADDRESS ISPEXEC "VPUT SECRC PROFILE"
  EXIT 04
END
SAY         "TSS LIST("ACID") DATA(NAME)"
NOCHECK: NOP
ADDRESS TSO
IF ACCESS = "REVOKE" THEN DO
  Q = OUTTRAP(REVOKE.)
  SAY "T80PER: REVOKE FUNTION STARTED"
  "TSS REV("ACID") DSN("DSNAME")"
  RCODE = RC
  IF RCODE = 0 THEN
    SECRC = "REVOKE FUNCTION SUCCESSFULL FOR ID "ACID
  ELSE DO
    SECRC = "REVOKE RETURNED NON ZERO RCODE OF " RCODE
    IF WORD(REVOKE.1,1) = "TSS0384E" THEN
      SECRC = "FAILED. CHECK THAT DSN IS IN PROFILE EXACTLY AS ENTERED."
    SAY SECRC "TSS REASON IS :"
    SAY "TSS TEXT REASON IS :"
    SAY REVOKE.1
    SAY REVOKE.2
  END
  ADDRESS ISPEXEC "VPUT SECRC PROFILE"
  EXIT
END
/********************************/
/* LETS ACTUALLY DO THE WORK... */
/********************************/
Q = OUTTRAP(OUT.,5)
IF RESTYPE = "DATASET" THEN RESTYPE = "DSN"
IF ACCESS = "REMOVE" THEN DO
  "TSS REV("ACID") "RESTYPE"("RESNAME")"
  RCODE = RC
  IF RCODE = 0 THEN
    SECRC = "AUTHORITY REMOVED FOR ID "ACID"."
  ELSE DO
    SECRC = "REMOVE RETURNED NON ZERO RCODE OF "RCODE
    MSG2 = OUT.1
    ADDRESS ISPEXEC "VPUT MSG2 PROFILE"
  END
  ADDRESS ISPEXEC "VPUT SECRC PROFILE"
  EXIT
END
IF DAYS = " " THEN
  "TSS PER("ACID") "RESTYPE"("RESNAME") ACCESS("ACCESS")" ACTION
ELSE
  "TSS PER("ACID") DSN("RESNAME")",
  "ACCESS("ACCESS")" DAYCMD ACTION
RCODE = RC
IF RCODE = 0 THEN
  secrc = "TSA521I: permit function successful for id" acid
ELSE DO
  secrc = "TSA522I: permit returned non zero rcode of "rcode
  MSG2 = OUT.1
  ADDRESS ISPEXEC "VPUT MSG2 PROFILE"
END
ADDRESS ISPEXEC "VPUT SECRC PROFILE"
EXIT
